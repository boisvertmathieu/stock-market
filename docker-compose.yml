services:
  trader:
    build: .
    container_name: stock-trader
    # Memory limits for Raspberry Pi (prevents OOM kills)
    mem_limit: 256m
    memswap_limit: 512m
    volumes:
      - ./data:/app/data # Persist state between runs
      - ./.env:/app/.env:ro # Environment variables
    environment:
      - TZ=America/New_York
      - PYTHONUNBUFFERED=1
    restart: always # Auto-restart on Pi reboot

  # Scheduled runner using ofelia (cron for Docker)
  # Works on Raspberry Pi (ARM64)
  scheduler:
    image: mcuadros/ofelia:latest
    container_name: stock-scheduler
    depends_on:
      - trader
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Sync timezone with host to ensure schedule runs on local time
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=America/New_York
    command: daemon --docker
    restart: always # Auto-restart on Pi reboot
    labels:
      ofelia.enabled: "true"
      # Run every 2 hours during market hours (9:30, 11:30, 13:30, 15:30 EST, Mon-Fri)
      ofelia.job-exec.trading.schedule: "0 30 9,11,13,15 * * 1-5"
      ofelia.job-exec.trading.container: "stock-trader"
      ofelia.job-exec.trading.command: "python -m src.main longrun --execute --email"
